<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>File Explorer</title>
    <style>
        body {
            font-family: sans-serif;
        }

        .item {
            margin: 0.5rem 0;
            cursor: pointer;
        }

        .folder {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>File Explorer</h1>
    <div id="path"></div>
    <div id="contents"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        let currentPath = "/";

        const Icons = {
            folder: "📁",
            file: "📄"
        };

        function formatBytes(bytes) {
            const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
            if (bytes === 0) return "0 Bytes";
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            const size = bytes / Math.pow(1024, i);
            return `${size.toFixed(2)} ${sizes[i]}`;
        }

        function loadDirectory(path = "") {
            currentPath = path || "/";
            const apiPath = currentPath === "/" ? "" : currentPath;

            $.getJSON(`/api/fileexplorer/${apiPath}`, function (data) {
                $("#path").text(`Path: ${data.path}`);

                const $contents = $("#contents");
                $contents.empty();

                $("<div>")
                    .css("margin-bottom", "1rem")
                    .text(`${Icons.file} ${data.fileCount} files, ${Icons.folder} ${data.folderCount} folders, ${formatBytes(data.totalSizeBytes)} total`)
                    .appendTo($contents);

                renderBreadcrumbs(path);

                data.directories.forEach(dir => {
                    $("<div>")
                        .addClass("directory item folder")
                        .css("cursor", "pointer")
                        .text(`${Icons.folder} ${dir.name}`)
                        .on("click", () => {
                            const newPath = path === "" || path === "/" ? dir.name : `${path}/${dir.name}`;
                            history.pushState({ path: newPath }, "", `/?path=${encodeURIComponent(newPath)}`);
                            currentPath = newPath;
                            loadDirectory(newPath);
                        })
                        .appendTo($contents);
                });

                data.files.forEach(file => {
                    const $fileDiv = $("<div>")
                        .addClass("item")
                        .text(`${Icons.file} ${file.name} (${formatBytes(file.size)})`);

                    $fileDiv.appendTo($contents);
                });

            }).fail(() => {
                $("#contents").html("<div>Error loading directory.</div>");
            });
        }

        function renderBreadcrumbs(path) {
            path = path.replace(/^\/|\/$/g, "");
            const $pathDiv = $("#path");
            $pathDiv.empty();

            const $home = $("<span>")
                .addClass("breadcrumb")
                .css("cursor", "pointer")
                .text("Home")
                .on("click", () => {
                    history.pushState({ path: "/" }, "", "/");
                    loadDirectory("/");
                });

            $pathDiv.append($home);

            if (path) {
                const parts = path.split("/");
                let combinedPath = "";
                parts.forEach((part, idx) => {
                    combinedPath += (idx === 0 ? "" : "/") + part;
                    $pathDiv.append(" / ");
                    const $crumb = $("<span>")
                        .addClass("breadcrumb")
                        .css("cursor", "pointer")
                        .text(part)
                        .on("click", () => {
                            history.pushState({ path: combinedPath }, "", `/?path=${encodeURIComponent(combinedPath)}`);
                            loadDirectory(combinedPath);
                        });
                    $pathDiv.append($crumb);
                });
            }
        }

        $(document).ready(() => {
            const params = new URLSearchParams(window.location.search);
            const initialPath = params.get("path") || "";
            loadDirectory(initialPath);
        });

    </script>
</body>

</html>