<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>File Explorer</title>
    <style>
        body {
            font-family: sans-serif;
        }

        .item {
            margin: 0.5rem 0;
            cursor: pointer;
        }

        .folder {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h1>File Explorer</h1>
    <form id="upload-form">
        <input type="file" id="file-input" name="file" />
        <button type="submit">Upload</button>
    </form>
    <div id="path"></div>
    <div id="contents"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        let currentPath = "/";

        const Icons = {
            folder: "📂",
            file: "📄",
            download: "📥",
            upload: "📤"
        };

        function formatBytes(bytes) {
            const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
            if (bytes === 0) return "0 Bytes";
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            const size = bytes / Math.pow(1024, i);
            return `${size.toFixed(2)} ${sizes[i]}`;
        }

        function loadDirectory(path = "") {
            currentPath = path || "/";
            const apiPath = currentPath === "/" ? "" : currentPath;

            $.getJSON(`/api/fileexplorer/${apiPath}`, function (data) {
                $("#path").text(`Path: ${data.path}`);

                const $contents = $("#contents");
                $contents.empty();

                $("<div>")
                    .css("margin-bottom", "1rem")
                    .text(`${Icons.file} ${data.fileCount} files, ${Icons.folder} ${data.folderCount} folders, ${formatBytes(data.totalSizeBytes)} total`)
                    .appendTo($contents);

                renderBreadcrumbs(path);

                data.directories.forEach(dir => {
                    const $folderDiv = $("<div>")
                        .addClass("directory item folder")
                        .css("cursor", "pointer")
                        .text(`${Icons.folder} ${dir.name}`)
                        .on("click", () => {
                            const newPath = path === "" || path === "/" ? dir.name : `${path}/${dir.name}`;
                            history.pushState({ path: newPath }, "", `/?path=${encodeURIComponent(newPath)}`);
                            currentPath = newPath;
                            loadDirectory(newPath);
                        });

                    const $deleteFolderBtn = $("<button>")
                        .text("Delete")
                        .css({ marginLeft: "0.5rem", color: "red" })
                        .on("click", (e) => {
                            e.stopPropagation();
                            if (confirm(`Delete folder "${dir.name}" and its contents?`)) {
                                const deletePath = path ? `${path}/${dir.name}` : dir.name;
                                $.ajax({
                                    url: `/api/fileexplorer/delete?path=${encodeURIComponent(deletePath)}`,
                                    type: "DELETE",
                                    success: () => {
                                        loadDirectory(currentPath);
                                    },
                                    error: (xhr) => {
                                        alert("Delete failed: " + xhr.responseText);
                                    }
                                });
                            }
                        });

                    $folderDiv.append($deleteFolderBtn);
                    $folderDiv.appendTo($contents);

                });

                data.files.forEach(file => {
                    const $fileDiv = $("<div>")
                        .addClass("item")
                        .text(`${Icons.file} ${file.name} (${formatBytes(file.size)})`);

                    const $downloadBtn = $("<button>")
                        .text(`${Icons.download}`)
                        .css({ marginLeft: "1rem" })
                        .on("click", () => {
                            const downloadPath = path ? `${path}/${file.name}` : file.name;
                            window.location.href = `/api/fileexplorer/download?path=${encodeURIComponent(downloadPath)}`;
                        });

                    const $deleteBtn = $("<button>")
                        .text("Delete")
                        .css({ marginLeft: "0.5rem", color: "red" })
                        .on("click", () => {
                            if (confirm(`Delete file "${file.name}"?`)) {
                                const deletePath = path ? `${path}/${file.name}` : file.name;
                                $.ajax({
                                    url: `/api/fileexplorer/delete?path=${encodeURIComponent(deletePath)}`,
                                    type: "DELETE",
                                    success: () => {
                                        loadDirectory(currentPath);
                                    },
                                    error: (xhr) => {
                                        alert("Delete failed: " + xhr.responseText);
                                    }
                                });
                            }
                        });

                    $fileDiv.append($deleteBtn);
                    $fileDiv.append($downloadBtn);
                    $fileDiv.appendTo($contents);
                });

            }).fail(() => {
                $("#contents").html("<div>Error loading directory.</div>");
            });
        }

        function renderBreadcrumbs(path) {
            path = path.replace(/^\/|\/$/g, "");
            const $pathDiv = $("#path");
            $pathDiv.empty();

            const $home = $("<span>")
                .addClass("breadcrumb")
                .css("cursor", "pointer")
                .text("Home")
                .on("click", () => {
                    history.pushState({ path: "/" }, "", "/");
                    loadDirectory("/");
                });

            $pathDiv.append($home);

            if (path) {
                const parts = path.split("/");
                let combinedPath = "";
                parts.forEach((part, idx) => {
                    combinedPath += (idx === 0 ? "" : "/") + part;
                    $pathDiv.append(" / ");
                    const $crumb = $("<span>")
                        .addClass("breadcrumb")
                        .css("cursor", "pointer")
                        .text(part)
                        .on("click", () => {
                            history.pushState({ path: combinedPath }, "", `/?path=${encodeURIComponent(combinedPath)}`);
                            loadDirectory(combinedPath);
                        });
                    $pathDiv.append($crumb);
                });
            }
        }

        $(document).ready(() => {
            const params = new URLSearchParams(window.location.search);
            const initialPath = params.get("path") || "";
            loadDirectory(initialPath);

            window.onpopstate = function (event) {
                const path = event.state?.path || "";
                loadDirectory(path);
            };
        });

        $('#upload-form').on('submit', function (e) {
            e.preventDefault();

            const fileInput = $('#file-input')[0];
            if (fileInput.files.length === 0) return;

            let uploadPath = currentPath;
            if (!uploadPath || uploadPath === "/") {
                uploadPath = "."; // telling backend this is the root directory
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('path', uploadPath);

            $.ajax({
                url: '/api/fileexplorer/upload',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function () {
                    alert('Upload successful!');
                    loadDirectory(currentPath);
                },
                error: function (xhr) {
                    alert('Upload failed: ' + xhr.responseText);


                }
            });
        });
    </script>
</body>

</html>