<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>File Explorer</title>
    <style>
        body {
            font-family: sans-serif;
        }

        .item {
            margin: 0.5rem 0;
            cursor: pointer;
        }

        .folder {
            font-weight: bold;
        }

        .selected-folder {
            background-color: #c9ebf6;
            border-radius: 4px;
            padding: 0.25rem;
        }

        .move-folder:hover {
            background-color: #e0e9ed;
        }
    </style>
</head>

<body>
    <h1>File Explorer</h1>
    <form id="upload-form">
        <input type="file" id="file-input" name="file" />
        <button type="submit">Upload</button>
    </form>
    <div id="path"></div>
    <div id="contents"></div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        /// Constant and Global variables ///
        let currentPath = "/";
        let itemToMove = null;

        const Icons = {
            folder: "📂",
            file: "📄",
            download: "📥",
            upload: "📤"
        };

        /// Util Functions ///
        function formatBytes(bytes) {
            const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
            if (bytes === 0) return "0 Bytes";
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(2)} ${sizes[i]}`;
        }

        function clearSelection() {
            $(".move-folder").removeClass("selected-folder");
            $("#confirm-move").prop("disabled", true).removeData("destPath");
        }

        function joinPaths(a, b) {
            return `${a.replace(/\/+$/, '')}/${b.replace(/^\/+/, '')}`;
        }

        /// Directory Rendering ///
        function loadDirectory(path = "") {
            currentPath = path || "/";
            const apiPath = currentPath === "/" ? "" : currentPath;

            $.getJSON(`/api/fileexplorer/${apiPath}`, function (data) {
                $("#path").text(`Path: ${data.path}`);

                const $contents = $("#contents").empty();

                $("<div>")
                    .css("margin-bottom", "1rem")
                    .text(`${Icons.file} ${data.fileCount} files, ${Icons.folder} ${data.folderCount} folders, ${formatBytes(data.totalSizeBytes)} total`)
                    .appendTo($contents);

                renderBreadcrumbs(path);
                renderFolders(data.directories, path, $contents);
                renderFiles(data.files, path, $contents);
            }).fail(() => {
                $("#contents").html("<div>Error rendering directory.</div>");
            });
        }

        function renderFolders(folders, path, $container) {
            folders.forEach(dir => {
                const $folderDiv = $("<div>")
                    .addClass("directory item folder")
                    .css("cursor", "pointer")
                    .text(`${Icons.folder} ${dir.name}`)
                    .on("click", () => {
                        const newPath = joinPaths(path, dir.name);
                        history.pushState({ path: newPath }, "", `/?path=${encodeURIComponent(newPath)}`);
                        currentPath = newPath;
                        loadDirectory(newPath);
                    });

                const $deleteFolderBtn = $("<button>")
                    .text("Delete")
                    .css({ marginLeft: "0.5rem", color: "red" })
                    .on("click", (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete folder "${dir.name}" and all its contents?`)) {
                            const deletePath = path ? `${path}/${dir.name}` : dir.name;
                            deleteItem(deletePath);
                        }
                    });

                const $moveFolderBtn = $("<button>")
                    .text("Move")
                    .css({ marginLeft: "0.5rem" })
                    .on("click", (e) => {
                        e.stopPropagation();
                        const fullPath = path ? `${path}/${dir.name}` : dir.name;
                        openMoveModal(fullPath);
                    });

                $folderDiv.append($deleteFolderBtn, $moveFolderBtn).appendTo($container);
            });
        }

        function renderFiles(files, path, $container) {
            files.forEach(file => {
                const fullPath = path ? `${path}/${file.name}` : file.name;

                const $fileDiv = $("<div>")
                    .addClass("item")
                    .text(`${Icons.file} ${file.name} (${formatBytes(file.size)})`);

                const $downloadBtn = $("<button>")
                    .text("Download")
                    .css({ marginLeft: "1rem" })
                    .on("click", () => {
                        window.location.href = `/api/fileexplorer/download?path=${encodeURIComponent(fullPath)}`;
                    });

                const $deleteBtn = $("<button>")
                    .text("Delete")
                    .css({ marginLeft: "0.5rem", color: "red" })
                    .on("click", () => {
                        if (confirm(`Delete file "${file.name}"?`)) {
                            deleteItem(fullPath);
                        }
                    });

                const $moveBtn = $("<button>")
                    .text("Move")
                    .css({ marginLeft: "0.5rem" })
                    .on("click", () => openMoveModal(fullPath));

                $fileDiv.append($deleteBtn, $downloadBtn, $moveBtn).appendTo($container);
            });
        }

        function renderBreadcrumbs(path) {
            path = path.replace(/^\/|\/$/g, "");
            const $pathDiv = $("#path").empty();

            $("<span>")
                .addClass("breadcrumb")
                .css("cursor", "pointer")
                .text("Home")
                .on("click", () => {
                    history.pushState({ path: "/" }, "", "/");
                    loadDirectory("/");
                }).appendTo($pathDiv);

            if (path) {
                const parts = path.split("/");
                parts.forEach((part, idx) => {
                    const partPath = parts.slice(0, idx + 1).join("/");
                    $pathDiv.append(" / ");
                    $("<span>")
                        .addClass("breadcrumb")
                        .css("cursor", "pointer")
                        .text(part)
                        .on("click", () => {
                            history.pushState({ path: partPath }, "", `/?path=${encodeURIComponent(partPath)}`);
                            loadDirectory(partPath);
                        }).appendTo($pathDiv);
                });
            }
        }

        /// Deletion ///
        function deleteItem(path) {
            $.ajax({
                url: `/api/fileexplorer/delete?path=${encodeURIComponent(path)}`,
                type: "DELETE",
                success: () => loadDirectory(currentPath),
                error: (xhr) => alert("Delete failed: " + xhr.responseText)
            });
        }

        /// File Uploads ///
        $('#upload-form').on('submit', function (e) {
            e.preventDefault();

            const fileInput = $('#file-input')[0];
            if (fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            const fileName = file.name;
            let uploadPath = currentPath === "/" ? "." : currentPath;

            // Does file being uploaded already exist?
            $.get('/api/fileexplorer/exists', { path: uploadPath, filename: fileName }, function (response) {
                if (response.exists) {
                    if (!confirm(`"${fileName}" already exists. Replace it?`)) {
                        return;
                    }
                }

                const formData = new FormData();
                formData.append('file', file);
                formData.append('path', uploadPath);

                $.ajax({
                    url: '/api/fileexplorer/upload',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: () => {
                        alert('Upload successful!');
                        loadDirectory(currentPath);
                    },
                    error: (xhr) => alert('Upload failed: ' + xhr.responseText)
                });
            });
        });

        /// Move Functionality ///
        function openMoveModal(sourcePath) {
            itemToMove = sourcePath;
            clearSelection();
            $("#move-modal").show();
            loadDestinationBrowser("/");
        }

        function loadDestinationBrowser(path) {
            $.getJSON(`/api/fileexplorer/${path === "/" ? "" : path}`, function (data) {
                const $browser = $("#destination-browser").empty();
                $("<div>").text(`Current: ${path}`).css({ fontWeight: "bold", marginBottom: "0.5rem" }).appendTo($browser);

                if (path !== "/") {
                    const parentPath = path.split("/").slice(0, -1).join("/") || "/";
                    $("<div>")
                        .text("👈 Back ..")
                        .css("cursor", "pointer")
                        .on("click", () => {
                            clearSelection();
                            loadDestinationBrowser(parentPath);
                        }).appendTo($browser);
                }

                data.directories.forEach(dir => {
                    const newPath = path === "/" ? dir.name : `${path}/${dir.name}`;

                    $("<div>")
                        .addClass("move-folder")
                        .text(`📂 ${dir.name}`)
                        .css("cursor", "pointer")
                        .on("click", function () {
                            $(".move-folder").removeClass("selected-folder");
                            $(this).addClass("selected-folder");
                            $("#confirm-move").prop("disabled", false).data("destPath", newPath);
                        })
                        .on("dblclick", function () {
                            clearSelection();
                            loadDestinationBrowser(newPath);
                        }).appendTo($browser);
                });
            });
        }

        /// Event Setup ///
        $(document).ready(() => {
            const params = new URLSearchParams(window.location.search);
            const initialPath = params.get("path") || "";
            loadDirectory(initialPath);

            window.onpopstate = function (event) {
                const path = event.state?.path || "";
                loadDirectory(path);
            };

            $("#cancel-move").on("click", () => {
                $("#move-modal").hide();
                itemToMove = null;
            });

            $("#confirm-move").on("click", () => {
                const destPath = $("#confirm-move").data("destPath");
                if (!itemToMove || !destPath) return;

                $.post(`/api/fileexplorer/move?sourcePath=${encodeURIComponent(itemToMove)}&destinationPath=${encodeURIComponent(destPath)}`)
                    .done(() => {
                        alert("Successfully Moved!");
                        $("#move-modal").hide();
                        loadDirectory(currentPath);
                    })
                    .fail((xhr) => {
                        alert("Move failed: " + xhr.responseText);
                    });
            });
        });
    </script>

    <div id="move-modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
    background:white; border:1px solid #ccc; padding:1rem; z-index:9999; max-height:80vh; overflow:auto;">
        <h3>Select Destination</h3>
        <div id="destination-browser"></div>
        <div style="margin-top:1rem;">
            <button id="confirm-move">Move Here</button>
            <button id="cancel-move">Cancel</button>
        </div>
    </div>
</body>

</html>